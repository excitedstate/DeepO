<img src="data/pic/logo_black.png" width="200">

## Forked From [RUC-AIDB/DeepO](https://github.com/RUC-AIDB/DeepO)

## ä»‹ç»

![img.png](data/pic/process.png)

> <span style="font-size:30px;margin-right:10px;color:rgba(0,0,0,0.0);"><i>0</i></span>
> æ ¹æ® `DeepO` çš„å®ç°é€»è¾‘ï¼Œæœ¬ç« ä¹Ÿå°† `DeepO` åˆ†ä¸ºç¦»çº¿çš„ä»£ä»·æ¨¡å‹è®­ç»ƒé˜¶æ®µå’Œåœ¨çº¿çš„æŸ¥è¯¢ä¼˜åŒ–é˜¶æ®µï¼Œåæ–‡ç§°ä¸ºé˜¶æ®µIå’Œé˜¶æ®µII
> <span style="font-size:30px;margin-right:10px;color:rgba(0,0,0,0.1);"><i>1</i></span>
> é˜¶æ®µ I å…ˆå®ç°æŸ¥è¯¢è®¡åˆ’çš„äºŒå‰æ ‘é‡æ„å’Œç‰¹å¾æå–ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šå®ŒæˆæŸ¥è¯¢è®¡åˆ’çš„åµŒå…¥ï¼Œç”Ÿæˆæ•°å€¼å‘é‡è¡¨ç¤ºçš„è®­ç»ƒæ•°æ®å¹¶åœ¨è´å¶æ–¯`LSTM`
> ç½‘ç»œä¸­è®­ç»ƒä»£ä»·é¢„æµ‹ç½‘ç»œã€‚é˜¶æ®µIçš„è¾“å‡ºåŒ…æ‹¬æŸ¥è¯¢è®¡åˆ’åµŒå…¥æ¨¡å‹ï¼ˆä¸»è¦æŒ‡èŠ‚ç‚¹ç¼–ç ç½‘ç»œï¼‰å’Œä»£ä»·é¢„æµ‹ç½‘ç»œã€‚<br>
> <span style="font-size:30px;margin-right:10px;color:rgba(0,0,0,0.1);"><i>2</i></span>
> é˜¶æ®µ II é¦–å…ˆä¼šå¯¹ç”¨æˆ·è¾“å…¥çš„`SQL`åšè§£æï¼Œè·å–æŸ¥è¯¢æ¶‰åŠåˆ°çš„æ‰€æœ‰è¡¨è¿›è€Œç”Ÿæˆç”¨äºå¯ä¿®æ”¹æŸ¥è¯¢ç­–ç•¥çš„`Hint`æ ‡å®šåˆ°`SQL`è¯­å¥å‰ï¼Œ
> `Hint` å¯è°ƒæ•´ç‰©ç†æŸ¥è¯¢è®¡åˆ’è¡¨æ‰«æç®—æ³•ã€è¡¨è¿æ¥ç®—æ³•å’Œè¡¨è¿æ¥é¡ºåºã€‚æ¥ç€åˆ©ç”¨
> `PostgreSQL` çš„ `EXPLAIN` æŒ‡ä»¤è·å–æ‰€æœ‰è¢«æ ‡å®š `Hint` çš„ `SQL` çš„ç‰©ç†æŸ¥è¯¢è®¡åˆ’ï¼Œå¹¶åº”ç”¨é˜¶æ®µIç”Ÿæˆçš„æŸ¥è¯¢è®¡åˆ’åµŒå…¥æ¨¡å‹ç”Ÿæˆç½‘ç»œæŸ¥è¯¢è®¡åˆ’åµŒå…¥å‘é‡ï¼Œ
> è¾“å…¥åˆ°ä»£ä»·é¢„æµ‹æ¨¡å‹ä¸­è·å–æœ¬æŸ¥è¯¢çš„ä»£ä»·ä¼°è®¡å€¼ã€‚<br>
> <span style="font-size:30px;margin-right:10px;color:rgba(0,0,0,0);"><i>3</i></span>
> ä»£ä»·é¢„æµ‹ç½‘ç»œä½¿ç”¨äº†è´å¶æ–¯ LSTM ç½‘ç»œï¼Œè¿™æ„å‘³ç€ç½‘ç»œä¸­çš„éƒ¨åˆ†å‚æ•°ä¸ºéšæœºå˜é‡ï¼Œå› æ­¤å¯¹äºç›¸åŒçš„æŸ¥è¯¢è®¡åˆ’ï¼Œç½‘ç»œçš„è¾“å‡ºå¯èƒ½ä¼šæœ‰å·®å¼‚ã€‚
> ç¨‹åºä¼šè·å–åŒä¸€æŸ¥è¯¢è®¡åˆ’çš„å¤šæ¬¡ä»£ä»·ä¼°è®¡å€¼å¹¶è®¡ç®—å‡å€¼å’Œæ–¹å·®ï¼ŒæŒ‰å‡å€¼å’Œæ–¹å·®å¯¹è·å–åˆ°çš„å…¨éƒ¨æŸ¥è¯¢è®¡åˆ’æ’åºï¼Œ
> é€‰å‡ºæ’åé å‰çš„`Top k`ä¸ªæŸ¥è¯¢è®¡åˆ’åŠå…¶å¯¹åº”çš„`Hint`ä½œä¸ºé˜¶æ®µIIçš„è¾“å‡ºã€‚

### ä¸»è¦ä¿®æ”¹

> æœ¬ç« å®ç°çš„ DeepO éµå¾ªäº†ä½œè€…åœ¨æ–‡ä¸­çš„æ€»ä½“å®ç°æ€è·¯ï¼Œä½†å¯¹æŸ¥è¯¢è®¡åˆ’çš„åµŒå…¥è¿‡ç¨‹åšäº†éƒ¨åˆ†ä¿®æ”¹
> - ä¿®æ”¹ä½œè€…æä¾›çš„å¯¹æŸ¥è¯¢è®¡åˆ’æ ‘çš„è¡¨ç¤ºé€»è¾‘ï¼Œå°† `PostgreSQL` æä¾›çš„ç‰©ç†æŸ¥è¯¢è®¡åˆ’è¡¨ç¤ºä¸ºèŠ‚ç‚¹æ“ä½œçš„äºŒå‰æ ‘å½¢å¼ï¼Œä¸”è¯¥æ“ä½œåœ¨é˜¶æ®µ I
    çš„è¾ƒæ—©é˜¶æ®µå®Œæˆï¼›
> - ä¿®æ”¹ä½œè€…å¯¹å¶å­èŠ‚ç‚¹çš„ç‰¹å¾æå–é€»è¾‘ï¼ŒåŠ å…¥äº†å¯¹ç”± `AND` å’Œ `OR` è¿æ¥çš„å¤åˆæ¡ä»¶è¡¨è¾¾å¼çš„æ”¯æŒä»¥åŠå¯¹ `ANY` å’Œ `ALL`
    è¿ç®—ç¬¦çš„æ”¯æŒã€‚å¦å¤–å¯¹å¸¸æ•°å€¼çš„æå–å’Œè§„èŒƒåŒ–ä¹Ÿè¢«å‰”é™¤ã€‚ä¸€æ–¹é¢ï¼Œè¿™æ ·åšå¯ä»¥é¿å… `DeepO` å¯¹åŸºæ•°ä¼°è®¡çš„ä¾èµ–ï¼›å¦ä¸€æ–¹é¢ï¼Œç”±äº` DeepO`
    è¢«è®¾è®¡ä¸ºå¯ä¸æ–­å­¦ä¹ ä¸”éœ€è¦é‡å¤è®­ç»ƒçš„æŸ¥è¯¢ä¼˜åŒ–å™¨ï¼Œåœ¨è®­ç»ƒæ•°æ®è¾ƒå°‘çš„æƒ…å†µä¸‹ï¼Œæ¨¡å‹å¯èƒ½ä¼šå¯¹ç‰¹å®šçš„çš„å¸¸æ•°å€¼äº§ç”Ÿä¾èµ–è€Œå½±å“åç»­çš„å­¦ä¹ è¿‡ç¨‹ï¼›
> - ä¿®æ”¹ä½œè€…å¯¹å¶å­èŠ‚ç‚¹å’Œéå¶èŠ‚ç‚¹åˆ†åˆ«å¤„ç†ã€åˆ†åˆ«ç¼–ç çš„è¿‡ç¨‹ï¼Œå°†å®ƒä»¬ç»Ÿä¸€ä¸ºç›¸åŒçš„æŸ¥è¯¢è®¡åˆ’èŠ‚ç‚¹æè¿°ï¼Œå¹¶åœ¨æŸ¥è¯¢è®¡åˆ’åµŒå…¥æ—¶è€ƒè™‘èŠ‚ç‚¹æ‰€å¤„çš„ä½ç½®ã€‚

## ä»£ç ç›®å½•


|            ç›®å½•æˆ–æ–‡ä»¶	            |      ç®€ä»‹       |                          	ç›®å½•æˆ–æ–‡ä»¶                          |     	ç®€ä»‹     |
|:----------------------------:|:-------------:|:--------------------------------------------------------:|:-----------:|
|  [data/model](data/model)	   |   ä¿å­˜ç”Ÿæˆçš„æ¨¡å‹	    |             [src/config.py](src/config.py)	              |   å­˜å‚¨é…ç½®ä¿¡æ¯    |
|    [data/npy](data/npy)	     |    ä¿å­˜è®­ç»ƒæ•°æ®	    |         [src/query_plan.py](src/query_plan.py)	          |   æŸ¥è¯¢è®¡åˆ’æ ¼å¼åŒ–   |
|  [data/output](data/output)  |  	ä¿å­˜æŸ¥è¯¢è®¡åˆ’è¾“å‡ºç»“æœ  |          [src/embedding.py](src/embedding.py)	           |   æŸ¥è¯¢è®¡åˆ’åµŒå…¥    |
|    [data/pic](data/pic)	     |  ä¿å­˜é¡¹ç›®æ‰€éœ€è¦çš„å›¾åƒ   |       [src/cost_learner.py](src/cost_learner.py)	        |  ä»£ä»·ä¼°è®¡æ¨¡å‹è®­ç»ƒ   |
|    [data/pkl](data/pkl)	     | ä¿å­˜pickleåºåˆ—åŒ–å¯¹è±¡ | [src/extract_table_names.py](src/extract_table_names.py) | 	è·å–SQLè¯­å¥ä¸­çš„è¡¨ |
|   [data/*plan](data/plan)    |  	ä¿å­˜è®­ç»ƒç”¨æŸ¥è¯¢è®¡åˆ’   |      [src/hint_generate.py](src/hint_generate.py)	       |  è·å–ä¼˜åŒ–æŸ¥è¯¢è®¡åˆ’   |
| [src/basic.py](src/basic.py) | 	æ•°æ®åº“è¿æ¥ç±»å’Œæ—¥å¿—ç±»	  |                   [main.py](main.py)	                    |  æµ‹è¯•å·²å®ç°çš„åŠŸèƒ½   |

## è¿è¡Œ

### æ•°æ®åº“å’Œè®­ç»ƒç¯å¢ƒå‡†å¤‡

1. æ‚¨å¯ä»¥åœ¨`windows`, `mac`æˆ–`linux`ä¸Šè¿è¡Œè¯¥é¡¹ç›®
2. å®‰è£…`PostgreSQL`æ•°æ®åº“ï¼Œå¤ç°æ—¶ä½¿ç”¨çš„ç‰ˆæœ¬ä¸º14
3. åœ¨`PostgreSQL`ä¸­å®‰è£…å¥½[`pg_hint_plan`](https://pghintplan.osdn.jp/pg_hint_plan.html)æ’ä»¶
4. ä¸‹è½½é¡¹ç›®[`JOB`](https://github.com/concretevitamin/join-order-benchmark),
   æŒ‰ç…§è¯¥é¡¹ç›®[`README`](https://github.com/concretevitamin/join-order-benchmark/blob/master/README.md)çš„æ­¥éª¤è½½å…¥`IMDB`
   æ•°æ®åº“
5. `JOB`ä¸­æä¾›äº†ä¸€éƒ¨åˆ†è®­ç»ƒæ•°æ®, è½½å…¥å®Œæˆå, å¦‚æœç´¢å¼•æœ‰é—®é¢˜ï¼Œè¯·æ‰§è¡Œ`fkindexes.sql`ä¿®å¤
6. è®­ç»ƒæ•°æ®çš„å¦ä¸€éƒ¨åˆ†æ¥è‡ªé¡¹ç›®[`learnedcardinalities/workloads`](https://github.com/andreaskipf/learnedcardinalities/tree/master/workloads),
æ‚¨å¯ä»¥ä¸‹è½½è¯¥é¡¹ç›®æˆ–è€…ä»…ä¸‹è½½è´Ÿè½½

### `Python3`å®‰è£…å’Œç¯å¢ƒé…ç½®

1. æ¨è`python3.9`
2. è¯·ç¡®ä¿ä»¥ä¸‹ç¬¬ä¸‰æ–¹åº“å·²è¢«å®‰è£…
    - `tensorflow`: `2.6.0`, ç”¨äº**èŠ‚ç‚¹åµŒå…¥ç½‘ç»œ**çš„è®­ç»ƒ
    - `pytorch`: `1.12.1`, ç”¨äº**ä»£ä»·é¢„æµ‹ç½‘ç»œ**çš„è®­ç»ƒ
    - `scikit-learn`: `1.3.1`, ç”¨äºåš**å•è¯çš„`One-Hot`ç¼–ç ä»¥åŠæµ‹è¯•è®­ç»ƒé›†çš„åˆ’åˆ†**
    - `blitz`: `0.2.7`, ç”¨äºå°†`nn.Module`ä¸Šçš„æƒé‡é‡‡æ ·(**âš æš‚æ—¶åšè¿™æ ·è§£é‡Š, è¿™éƒ¨åˆ†äº†è§£çš„ä¸æ˜¯å¾ˆå…¨é¢**)
    - `sqlparse`: `0.4.3`, ç”¨äºè§£æç”¨æˆ·è¾“å…¥çš„`SQL`è¯­å¥
    - `psycopg2`: `2.9.1`, ç”¨äºå»ºç«‹ä¸`PostgreSQL`æ•°æ®åº“çš„è¿æ¥ (**âš ççˆ±ç”Ÿå‘½, è¿œç¦»`Apple M1`**)
    - `rich`, ç”¨äºæ‰“å°å¥½çœ‹çš„è¡¨æ ¼, æ‰“å°æ—¥å¿—, æ‰“å°å­—å…¸(**!å•Š, çˆ±æ­»è¿™ä¸ªåº“äº†**)
    - `tqdm`, ç”¨äºåšè¿›åº¦æ¡, ç”¨èµ·æ¥æ–¹ä¾¿, æ²¡æœ‰`rich`åšçš„å¥½çœ‹
3. å› ä¸ºè¯¥äº¤ä½œä¸šäº†, æ²¡æ¥å¾—åŠåšå‘½ä»¤è¡Œå‚æ•°, å› æ­¤ä¸‹é¢è„šæœ¬çš„æ‰§è¡Œæœ‰ç‚¹å¤æ‚, å¦‚æœæ‚¨æœ‰ä»»ä½•é—®é¢˜,
   éƒ½å¯ä»¥é€šè¿‡<a href="mailto://hanbing.mcga@qq.com">ğŸ“«ä¸ªäººé‚®ç®±</a>ä¸æˆ‘è”ç³»

### è·å–è®­ç»ƒæ•°æ®(æŸ¥è¯¢è®¡åˆ’)

1. æ‰“å¼€[`src/config.py`](src/config.py), ä¿®æ”¹å˜é‡`DB_LAB_VM_CONFIG`ä¸­ä¿å­˜çš„è¿æ¥ä¿¡æ¯ä¸ºè‡ªå·±çš„æ•°æ®åº“è¿æ¥ä¿¡æ¯
2. æ‰“å¼€[`main.py`](main.py), æŸ¥çœ‹`get_train_data`æ–¹æ³•, å°†å…¶ä¸­`sql_path`å˜é‡æ”¹æˆä½ è‡ªå·±ä¿å­˜SQLè¯­å¥çš„è·¯å¾„, `output_dir`
   ä¿®æ”¹ä¸ºä¿å­˜è¾“å‡ºæŸ¥è¯¢è®¡åˆ’çš„è·¯å¾„,
    - å¦‚æœæ‚¨ä½¿ç”¨å¦‚`Pycharm`è¿™æ ·çš„å¤§å‹`IDE`, è¯·ä¸€å®šå°†ä»¥ä¸Šè·¯å¾„`Excluded`
    - æ³¨æ„æ§åˆ¶å¹¶è¡Œæ‰§è¡Œçš„çº¿ç¨‹æ•°, è§†è‡ªå·±çš„æœåŠ¡å™¨æ€§èƒ½è€Œå®š, ä¿æŒ`DBMS`çš„`CPUå ç”¨ç‡`åœ¨`60%`ä»¥ä¸‹æœ€ä½³
3. æ³¨é‡Šæ‰`main`ä¸­å¤šä½™çš„éƒ¨åˆ†, åªæ‰§è¡Œ`get_train_data`å‡½æ•°

### è®­ç»ƒä»£ä»·ç½‘ç»œ

1. æ‰“å¼€[`main.py`](main.py), æŸ¥çœ‹å‡½æ•°`embedding_and_train_cost_net()`, è¯¥å‡½æ•°å°è£…äº†ä»£ä»·ç½‘ç»œè®­ç»ƒçš„å…¨è¿‡ç¨‹ï¼ŒåŒ…æ‹¬èŠ‚ç‚¹ç¼–ç ç½‘ç»œçš„è®­ç»ƒ
2. å¦‚æœå¯¹ç°åœ¨çš„æ­¤å‚æ•°ä¸æ»¡æ„ï¼Œæ‚¨å¯ä»¥åœ¨æ–‡ä»¶[`src/embedding`](src/embedding.py)
   å’Œæ–‡ä»¶[`src/cost_learner.py`](src/cost_learner.py)ä¸­ä¿®æ”¹

### è·å–æœ€ä½³ç½®ä¿¡åŒºé—´å’Œåœ¨çº¿æŸ¥è¯¢ä¼˜åŒ–

1. æ‰“å¼€[`main.py`](main.py), å‡½æ•°`get_width_of_confidence_intervals()`, è¯¥å‡½æ•°å¯ç”¨äºè·å–ç½®ä¿¡åŒºé—´,
   å³ç¬¬ä¸€ä¸ªæ¦‚ç‡è¶…è¿‡0.9çš„ci_multiplier
2. å‡½æ•°`query_optimization_demo`ç”¨äºæ‰§è¡Œä»¥ä¸‹SQLè¯­å¥çš„æŸ¥è¯¢ä¼˜åŒ–

```sql
select count(*)
from title t,
     movie_keyword mk
where t.id = mk.movie_id
  and mk.keyword_id = 20450;
```

## éƒ¨åˆ†æˆªå›¾

### æŸ¥è¯¢è®¡åˆ’åµŒå…¥

#### sqlè¯­å¥

```sql
/*+ SeqScan(t) SeqScan(mi) SeqScan(mi_idx) MergeJoin(t mi_idx) MergeJoin(mi t mi_idx) Leading (( mi ( t mi_idx ) )) */
EXPLAIN ANALYSE
SELECT COUNT(*)
FROM title t,
     movie_info mi,
     movie_info_idx mi_idx
WHERE t.ID = mi.movie_id
  AND T.ID = mi_idx.movie_id
  AND mi.info_type_id > 16
  AND mi_idx.info_type_id = 100;
```

#### `PostgreSQL` ç»™å‡ºçš„æŸ¥è¯¢è®¡åˆ’

![img_1.png](data/pic/img_1.png)

#### æŸ¥è¯¢è®¡åˆ’çš„äºŒå‰æ ‘è¡¨ç¤º

![img_2.png](data/pic/img_2.png)

#### æŸ¥è¯¢è®¡åˆ’çš„ååºéå†ç»“æœ

![img_3.png](data/pic/img_3.png)

#### èŠ‚ç‚¹ç¼–ç ç½‘ç»œç¤ºæ„å›¾

![img_4.png](data/pic/img_4.png)

#### èŠ‚ç‚¹ç¼–ç ç½‘ç»œçš„è®­ç»ƒè¿‡ç¨‹

![img_5.png](data/pic/img_5.png)

### ä»£ä»·é¢„æµ‹ç½‘ç»œ

#### ä»£ä»·é¢„æµ‹ç½‘ç»œç¤ºæ„å›¾

![img_6.png](data/pic/img_6.png)

#### ä»£ä»·é¢„æµ‹ç½‘ç»œè®­ç»ƒè¿‡ç¨‹ä¸­æŸå¤±å‡½æ•°è¾“å‡ºéšè¿­ä»£æ¬¡æ•°çš„å˜åŒ–å…³ç³»

![img_7.png](data/pic/img_7.png)

#### ç¡®å®šç½®ä¿¡åŒºé—´çš„å®éªŒæ•°æ®

<style>
.center 
{
  width: auto;
  display: table;
  margin-left: auto;
  margin-right: auto;
}
</style>

<p align="center"><font face="å¾®è½¯é›…é»‘" size=2.>è¡¨æ ¼: ç¡®å®šç½®ä¿¡åŒºé—´çš„å®éªŒæ•°æ®</font></p>

<div class="center" style="font-family: 'Consolas', 'Monaco', 'Bitstream Vera Sans Mono', monospace">

| ci_multiplier |       	è½åœ¨ç½®ä¿¡åŒºé—´çš„æ¦‚ç‡        | 	ci_multiplier	 | è½åœ¨ç½®ä¿¡åŒºé—´çš„æ¦‚ç‡ |
|:-------------:|:-----------------------:|:---------------:|:---------:|
|       6       | 	            0.150442 	 |       18	       | 0.823009  |
|       7       | 	            0.194690 	 |       19	       | 0.752212  |
|       8       | 	            0.185841 	 |       20	       | 0.840708  |
|       9       | 	            0.256637 	 |       21	       | 0.893805  |
|      10       |   	        0.265487 	   |       22	       | 0.840708  |
|      11       |   	        0.283186 	   |       23	       | 0.893805  |
|      12       |   	        0.380531 	   |       24	       | 0.946903  |
|      13       |   	        0.442478 	   |       25	       | 0.920354  |
|      14       |   	        0.433628 	   |       26	       | 0.929204  |
|      15       |   	        0.601770 	   |       27	       | 0.955752  |
|      16       |   	        0.672566 	   |       28	       | 0.946903  |
|      17       |   	        0.628319 	   |       29	       | 0.973451  |

</div>

### åœ¨çº¿æŸ¥è¯¢ä¼˜åŒ–é˜¶æ®µ

#### è·å–SQLä¸­æ¶‰åŠçš„è¡¨

```python

from src.extract_table_names import extract_tables

sql = """
select count(*) from title t, movie_keyword mk where t.id=mk.movie_id and mk.keyword_id = 20450;
"""

extract_tables(sql)
# # ['t', 'mk']
```

#### è·å–æ ‡å®šæŸ¥è¯¢ç­–ç•¥çš„SQLå…¨ä½“

![img_10.png](data/pic/img_10.png)

#### è·å–æŸ¥è¯¢è®¡åˆ’\(`EXPLAIN`\)

![img_11.png](data/pic/img_11.png)

#### ä½¿ç”¨ä»£ä»·é¢„æµ‹ç½‘ç»œè¿›è¡ŒæŸ¥è¯¢è®¡åˆ’çš„ä»£ä»·é¢„æµ‹ä»¥åŠæ‹©ä¼˜

![img_12.png](data/pic/img_12.png)